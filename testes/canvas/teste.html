<!doctype html>
<html>
<head>
    <title>Many Points with  leaflet Canvas</title>
    <meta charset="utf-8">

    <style>
        
        #map {
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: #333;
        }
    </style>

</head>
<body>
    <div id="map"></div>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="L.CanvasOverlay.js"></script>
    <script src="http://www.sumbera.com/gist/data.js" charset="utf-8"></script>


    <script>

        var points = data; // data loaded from data.js
        var leafletMap = L.map('map').setView([50.00, 14.44], 9);
        L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png")
            .addTo(leafletMap);

	var angles = calcAngles(100);
	console.log(angles);
        console.log([angles[0], angles[33], angles[66], angles[100]])

	for (var i=0; i<data.length; i++) {
	    data[i].stops = [0];
            data[i].votes = [2, 2, 1, 1, 1].map((weight) => Math.floor(Math.random() * 1000 * weight))
	    data[i].totalVotes = data[i].votes.reduce((total, number) => total + number, 0)
	    if (i==10) console.log('totalVotes = ', data[i].totalVotes)
	    // var notches = [0, Math.floor(Math.random() * 100), Math.floor(Math.random() * 100), Math.floor(Math.random() * 100), Math.floor(100.0)].sort(function(a, b){return a-b});	
	    data[i].percentages = data[i].votes.map((votes) => votes / data[i].totalVotes)
	    if (i==10) console.log('percentages = ', data[i].percentages)	
	    var notches = [0]
	    var lastPercentage = 0
	    data[i].percentages.forEach((percentage) => {
		lastPercentage += percentage
		notches.push(Math.round(lastPercentage * 100))
	    })
	    //notches.push(100)	
	    data[i].winner = data[i].votes.reduce((winner, votes, index, arr) => winner < 0 ? index : arr[winner] < votes ? index : winner, -1)	
	 	
	    data[i].stops = notches.map((notch) => angles[notch])
//		angles[notches[0]], 
//		angles[notches[1]],
//		angles[notches[2]],
//		angles[notches[3]],
//		angles[notches[4]] ] //[angles[0], angles[33], angles[66], angles[100]] 
	    if (i == 10){
		console.log(data[i].votes)
		console.log(data[i].percentages)
		console.log(data[i].winner)
		console.log(notches)
		 console.log(data[i].stops)
	    }	
	
	};

        var myCanvas = L.canvasOverlay()
            .drawing(drawingOnCanvas)
            .addTo(leafletMap);


        function calcAngles (numNotches = 100) {
	    var angles = [0]
            for (var i=1; i<=numNotches; i++) {
		angles.push(Math.PI * 2 * (i / numNotches))
            }
	    return angles;
	}



        function drawingOnCanvas(canvasOverlay, params) {
            var radius = Math.pow(2, leafletMap.getZoom() / 3),
		ctx = params.canvas.getContext('2d');

	    var colorSequence = ["229,57,53", "30,136,229", "251,140,0", "94,53,177", "3,155,229", "0,172,193", "255,179,0", "142,36,170", "57,73,171", "216,27,96", "192,202,51", "0,137,123", "253,216,53"]
	    var colors = colorSequence.map((color) => 'rgba(' + color + ',0.8)')


            ctx.clearRect(0, 0, params.canvas.width, params.canvas.height);
            //ctx.fillStyle = "rgba(255,116,0, 0.2)";
 
	    console.log(data.length + ' points');
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                if (params.bounds.contains([d[0], d[1]])) {
                    var dot = canvasOverlay._map.latLngToContainerPoint([d[0], d[1]]);
		    for (var j=0; j<d.stops.length-1; j++) {
			ctx.beginPath();
			ctx.moveTo(dot.x, dot.y);	
			if (i == 10) {
				console.log(d.stops[j], d.stops[j+1], colors[j])
			}
			ctx.arc(dot.x, dot.y, radius, d.stops[j], d.stops[j+1]);		
	                ctx.fillStyle = colors[j];
	                ctx.fill();
                        ctx.closePath();
		    }	
                }
            }
        };


        function drawingOnCanvas2(canvasOverlay, params) {
            var radius = Math.pow(2, leafletMap.getZoom() / 3),
		ctx = params.canvas.getContext('2d');

	    var colorSequence = ["229,57,53", "30,136,229", "251,140,0", "94,53,177", "3,155,229", "0,172,193", "255,179,0", "142,36,170", "57,73,171", "216,27,96", "192,202,51", "0,137,123", "253,216,53"]
	    var colors = colorSequence.map((color) => 'rgba(' + color + ',0.8)')


            ctx.clearRect(0, 0, params.canvas.width, params.canvas.height);
            //ctx.fillStyle = "rgba(255,116,0, 0.2)";
 
	    console.log(data.length + ' points');
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
		var winner = data[i].winner
		var color = colors[winner]
	        if (i >= 10 && i <= 20) console.log('winner = ', winner)
                if (params.bounds.contains([d[0], d[1]])) {
                    var dot = canvasOverlay._map.latLngToContainerPoint([d[0], d[1]]);
		    for (var j=0; j<d.stops.length-1; j++) {
			ctx.beginPath();
			ctx.moveTo(dot.x, dot.y);	
			if (i == 10) {
				console.log(d.stops[j], d.stops[j+1], colors[j])
			}
			ctx.arc(dot.x, dot.y, radius, d.stops[j], d.stops[j+1]);		
	                ctx.fillStyle = color //colors[j];
	                ctx.fill();
                        ctx.closePath();
		    }	
                }
            }
        };


setTimeout(() => {
  setInterval(() => {
    myCanvas.drawing(drawingOnCanvas)
    leafletMap.removeLayer(myCanvas)
    myCanvas.addTo(leafletMap)
  }, 4000)
}, 2000)

setInterval(() => {
	myCanvas.drawing(drawingOnCanvas2)
	leafletMap.removeLayer(myCanvas)
	myCanvas.addTo(leafletMap)
	//leafletMap._onResize();   // force redraw
}, 4000)


    </script>
</body>
</html>